"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[2497],{2497:(P,L,c)=>{c.d(L,{N:()=>D});var s=c(467),v=c(5083);const f=(0,v.F3)("Geolocation",{web:()=>c.e(2920).then(c.bind(c,2920)).then(e=>new e.GeolocationWeb)});!function N(e=!1){window.CapacitorUtils=window.CapacitorUtils||{},void 0===window.Capacitor||e?void 0!==window.cordova&&function H(e){e.CapacitorUtils.Synapse=new Proxy({},{get:(g,d)=>e.cordova.plugins[d]})}(window):function A(e){e.CapacitorUtils.Synapse=new Proxy({},{get:(g,d)=>new Proxy({},{get:(t,i)=>(n,r,o)=>{const a=e.Capacitor.Plugins[d];void 0!==a?"function"==typeof a[i]?(0,s.A)(function*(){try{const l=yield a[i](n);r(l)}catch(l){o(l)}})():o(new Error(`Method ${i} not found in Capacitor plugin ${d}`)):o(new Error(`Capacitor plugin ${d} not found`))}})})}(window)}();var p=c(8941),m=c(4412),h=c(1360);const T=(0,v.F3)("Preferences",{web:()=>c.e(2924).then(c.bind(c,2924)).then(e=>new e.PreferencesWeb)});let E=(()=>{var e;class g{constructor(){}set(t,i){return(0,s.A)(function*(){yield T.set({key:t,value:i})})()}get(t){return(0,s.A)(function*(){const{value:i}=yield T.get({key:t});return i})()}remove(t){return(0,s.A)(function*(){yield T.remove({key:t})})()}clear(){return(0,s.A)(function*(){yield T.clear()})()}}return(e=g).\u0275fac=function(t){return new(t||e)},e.\u0275prov=h.jDH({token:e,factory:e.\u0275fac,providedIn:"root"}),g})();const y=(0,v.F3)("LocalNotifications",{web:()=>c.e(4224).then(c.bind(c,4224)).then(e=>new e.LocalNotificationsWeb)});var k=c(5032);let j=(()=>{var e;class g{constructor(t){this.platform=t,this.TRACKING_NOTIFICATION_ID=999}showNotification(t,i){return(0,s.A)(function*(){try{if("granted"!==(yield y.checkPermissions()).display&&"granted"!==(yield y.requestPermissions()).display)return void console.log("Notification permission not granted");yield y.schedule({notifications:[{title:t,body:i,id:Math.floor(100*Math.random()),schedule:{at:new Date(Date.now())},sound:void 0,attachments:void 0,actionTypeId:"",extra:null}]})}catch(n){console.error("Error showing notification:",n)}})()}showTrackingNotification(t){var i=this;return(0,s.A)(function*(){try{if(!i.platform.is("capacitor"))return;t?yield y.schedule({notifications:[{title:"Location Tracking Active",body:"Your location is being tracked in the background",id:i.TRACKING_NOTIFICATION_ID,ongoing:!0,autoCancel:!1,sound:void 0,attachments:void 0,actionTypeId:"",extra:{tracking:"active"}}]}):yield y.cancel({notifications:[{id:i.TRACKING_NOTIFICATION_ID}]})}catch(n){console.error("Error with tracking notification:",n)}})()}}return(e=g).\u0275fac=function(t){return new(t||e)(h.KVO(k.OD))},e.\u0275prov=h.jDH({token:e,factory:e.\u0275fac,providedIn:"root"}),g})();const b=(0,v.F3)("BackgroundGeolocation");let D=(()=>{var e;class g{constructor(t,i,n){this.storageService=t,this.notificationService=i,this.platform=n,this.watchId=null,this.backgroundWatchId=null,this.defaultSettings={isTrackingEnabled:!1,isBackgroundTrackingEnabled:!1,showNotification:!0,trackingInterval:10,locationAccuracy:"high",radius:10},this.locationHistory=[],this.locationHistorySubject=new m.t([]),this.settingsSubject=new m.t(this.defaultSettings),this.locationStatsSubject=new m.t({totalDistance:0,totalTime:0}),this.isTracking=!1,this.isBackgroundTracking=!1,this.locationServicesStatus=new m.t(!0),this.locationMonitorInterval=null,this.loadSettings(),this.loadLocationHistory(),p.q.addListener("appStateChange",({isActive:r})=>{const o=this.settingsSubject.getValue();o.isTrackingEnabled&&(r?(this.isBackgroundTracking&&(this.stopBackgroundTracking(),this.startForegroundTracking()),this.checkLocationServices()):o.isBackgroundTrackingEnabled&&this.isTracking&&(this.stopForegroundTracking(),this.startBackgroundTracking())),r?this.startLocationServicesMonitor():this.stopLocationServicesMonitor()}),this.startLocationServicesMonitor()}requestLocationPermissions(){return(0,s.A)(function*(){try{return"granted"===(yield f.requestPermissions()).location}catch(t){return console.error("Error requesting location permissions:",t),!1}})()}checkLocationPermissions(){return(0,s.A)(function*(){try{return"granted"===(yield f.checkPermissions()).location}catch(t){return console.error("Error checking location permissions:",t),!1}})()}getCurrentPosition(){var t=this;return(0,s.A)(function*(){try{const i={enableHighAccuracy:t.getAccuracyFromSetting()},n=yield f.getCurrentPosition(i);return t.positionToLocationData(n)}catch(i){return console.error("Error getting current position:",i),2===i.code?yield t.notificationService.showNotification("Location Services Disabled","Please enable location services in your device settings to use this app."):1===i.code?yield t.notificationService.showNotification("Location Permission Denied","This app requires location permission to function properly."):yield t.notificationService.showNotification("Location Error","Unable to get current location. Please check your GPS settings."),null}})()}startTracking(){var t=this;return(0,s.A)(function*(){const i=t.settingsSubject.getValue();return i.isTrackingEnabled?t.isTracking||t.isBackgroundTracking:(i.isTrackingEnabled=!0,t.settingsSubject.next(i),yield t.saveSettings(),i.isBackgroundTrackingEnabled&&(yield t.notificationService.showTrackingNotification(!0)),t.startForegroundTracking())})()}stopTracking(){var t=this;return(0,s.A)(function*(){const i=t.settingsSubject.getValue();i.isTrackingEnabled=!1,t.settingsSubject.next(i),yield t.saveSettings(),yield t.stopForegroundTracking(),yield t.stopBackgroundTracking(),yield t.notificationService.showTrackingNotification(!1)})()}updateSettings(t){var i=this;return(0,s.A)(function*(){const n=i.settingsSubject.getValue(),r={...n,...t},o=n.isTrackingEnabled;i.settingsSubject.next(r),yield i.saveSettings(),r.isTrackingEnabled!==o&&(r.isTrackingEnabled?yield i.startTracking():yield i.stopTracking())})()}clearLocationHistory(){var t=this;return(0,s.A)(function*(){t.locationHistory=[],t.locationHistorySubject.next([]),t.locationStatsSubject.next({totalDistance:0,totalTime:0}),yield t.storageService.set("locationHistory",JSON.stringify([]))})()}getLocationHistory(){return this.locationHistorySubject.asObservable()}getSettings(){return this.settingsSubject.asObservable()}getLocationStats(){return this.locationStatsSubject.asObservable()}getLocationServicesStatus(){return this.locationServicesStatus.asObservable()}startForegroundTracking(){var t=this;return(0,s.A)(function*(){if(t.isTracking)return!0;try{if(!(yield t.checkLocationPermissions())&&!(yield t.requestLocationPermissions()))return yield t.notificationService.showNotification("Permission Required","Location permission is required for tracking"),!1;t.settingsSubject.getValue();const r={enableHighAccuracy:t.getAccuracyFromSetting(),timeout:1e4};t.watchId=yield f.watchPosition(r,(a,l)=>{if(l)return console.error("Geolocation watch error:",l),void t.handleLocationError(l);a&&t.handleNewPosition(a)}),t.isTracking=!0;const o=t.locationStatsSubject.getValue();return o.startTime||(o.startTime=Date.now(),t.locationStatsSubject.next(o)),!0}catch(i){return console.error("Error starting foreground location tracking:",i),yield t.notificationService.showNotification("Tracking Error","Failed to start location tracking"),!1}})()}stopForegroundTracking(){var t=this;return(0,s.A)(function*(){if(t.watchId){yield f.clearWatch({id:t.watchId}),t.watchId=null,t.isTracking=!1;const i=t.locationStatsSubject.getValue();i.endTime=Date.now(),i.startTime&&(i.totalTime+=(i.endTime-i.startTime)/1e3),t.locationStatsSubject.next(i)}})()}startBackgroundTracking(){var t=this;return(0,s.A)(function*(){if(t.isBackgroundTracking)return!0;try{const i=t.settingsSubject.getValue(),n=yield b.addWatcher({backgroundMessage:"Location tracking is active",backgroundTitle:"Location Tracker",requestPermissions:!0,stale:!1,distanceFilter:i.radius},(o,a)=>{if(a)return console.error("Background location error:",a),void("NOT_AUTHORIZED"===a.code&&t.notificationService.showNotification("Permission Error","Location permission denied. Please enable in settings."));if(o){const l={latitude:o.latitude,longitude:o.longitude,accuracy:o.accuracy,timestamp:new Date(o.time).getTime(),speed:o.speed||0,altitude:o.altitude||void 0,activityType:o.simpleActivity};t.addLocationToHistory(l)}});t.backgroundWatchId="string"==typeof n?n:"",t.isBackgroundTracking=!0,yield t.notificationService.showTrackingNotification(!0);const r=t.locationStatsSubject.getValue();return r.startTime||(r.startTime=Date.now(),t.locationStatsSubject.next(r)),!0}catch(i){return console.error("Error starting background location tracking:",i),yield t.notificationService.showNotification("Tracking Error","Failed to start background location tracking"),!1}})()}stopBackgroundTracking(){var t=this;return(0,s.A)(function*(){try{yield b.removeWatcher({id:t.backgroundWatchId||""}),t.backgroundWatchId=null,t.isBackgroundTracking=!1;const i=t.locationStatsSubject.getValue();i.endTime=Date.now(),i.startTime&&(i.totalTime+=(i.endTime-i.startTime)/1e3),t.locationStatsSubject.next(i)}catch(i){console.error("Error stopping background tracking:",i)}})()}handleNewPosition(t){const i=this.positionToLocationData(t);this.addLocationToHistory(i)}positionToLocationData(t){return{latitude:t.coords.latitude,longitude:t.coords.longitude,accuracy:t.coords.accuracy,timestamp:t.timestamp,speed:t.coords.speed||0,altitude:t.coords.altitude||void 0}}addLocationToHistory(t){var i=this;return(0,s.A)(function*(){const n=i.settingsSubject.getValue();if(0===i.locationHistory.length){i.locationHistory.push(t),i.locationHistorySubject.next([...i.locationHistory]);const u=i.locationStatsSubject.getValue();return u.startTime=t.timestamp,u.endTime=t.timestamp,i.locationStatsSubject.next({...u}),void(yield i.saveLocationHistory())}const r=i.locationHistory[i.locationHistory.length-1],o=i.calculateDistance(r.latitude,r.longitude,t.latitude,t.longitude),l=Math.max(r.accuracy,5)+Math.max(t.accuracy,5),S=t.timestamp-r.timestamp;if(o>=n.radius&&o>l&&(o>10||S>3e4)){i.locationHistory.push(t),i.locationHistorySubject.next([...i.locationHistory]);const u=i.locationStatsSubject.getValue();u.totalDistance+=o,u.endTime=t.timestamp,u.totalTime=(u.endTime-(u.startTime||0))/1e3,i.locationStatsSubject.next({...u}),console.log(`Added point - Distance: ${o.toFixed(2)}m, Accuracy: ${t.accuracy}m`),yield i.saveLocationHistory()}else console.log(`Skipped point - Distance: ${o.toFixed(2)}m, Accuracy: ${t.accuracy}m, TimeDiff: ${S/1e3}s`)})()}handleLocationError(t){console.error("Location error:",t),1===t.code?this.notificationService.showNotification("Permission Error","Location permission denied. Please enable in settings."):2===t.code?this.notificationService.showNotification("Location Services Disabled","Please enable location services in your device settings to use this app."):3===t.code&&this.notificationService.showNotification("Timeout Error","Location request timed out. Please try again later.")}calculateDistance(t,i,n,r){const a=this.toRadians(t),l=this.toRadians(n),S=this.toRadians(n-t),u=this.toRadians(r-i),w=Math.sin(S/2)*Math.sin(S/2)+Math.cos(a)*Math.cos(l)*Math.sin(u/2)*Math.sin(u/2);return 2*Math.atan2(Math.sqrt(w),Math.sqrt(1-w))*6371e3}toRadians(t){return t*Math.PI/180}getAccuracyFromSetting(){switch(this.settingsSubject.getValue().locationAccuracy){case"high":default:return!0;case"medium":case"low":return!1}}loadSettings(){var t=this;return(0,s.A)(function*(){try{const i=yield t.storageService.get("locationSettings");if(i){const n=JSON.parse(i);t.settingsSubject.next({...t.defaultSettings,...n})}}catch(i){console.error("Error loading location settings:",i)}})()}saveSettings(){var t=this;return(0,s.A)(function*(){try{const i=t.settingsSubject.getValue();yield t.storageService.set("locationSettings",JSON.stringify(i))}catch(i){console.error("Error saving location settings:",i)}})()}loadLocationHistory(){var t=this;return(0,s.A)(function*(){try{const i=yield t.storageService.get("locationHistory");i&&(t.locationHistory=JSON.parse(i),t.locationHistorySubject.next([...t.locationHistory]),t.recalculateStats())}catch(i){console.error("Error loading location history:",i)}})()}saveLocationHistory(){var t=this;return(0,s.A)(function*(){try{yield t.storageService.set("locationHistory",JSON.stringify(t.locationHistory))}catch(i){console.error("Error saving location history:",i)}})()}recalculateStats(){const t={totalDistance:0,totalTime:0};if(this.locationHistory.length>=2){for(let r=1;r<this.locationHistory.length;r++){const o=this.locationHistory[r-1],a=this.locationHistory[r];t.totalDistance+=this.calculateDistance(o.latitude,o.longitude,a.latitude,a.longitude)}const i=this.locationHistory[0],n=this.locationHistory[this.locationHistory.length-1];t.totalTime=(n.timestamp-i.timestamp)/1e3,t.startTime=i.timestamp,t.endTime=n.timestamp}this.locationStatsSubject.next(t)}checkLocationServices(){var t=this;return(0,s.A)(function*(){try{return yield f.getCurrentPosition({timeout:3e3,enableHighAccuracy:!1}),t.locationServicesStatus.next(!0),!0}catch(i){return console.log("Location services check error:",i),2!==i.code||(t.locationServicesStatus.next(!1),!1)}})()}startLocationServicesMonitor(){var t=this;this.locationMonitorInterval||(this.checkLocationServices(),this.locationMonitorInterval=setInterval((0,s.A)(function*(){const i=t.locationServicesStatus.getValue(),n=yield t.checkLocationServices();i&&!n&&(yield t.notificationService.showNotification("Location Services Disabled","Please enable location services in your device settings to use this app properly."))}),5e3))}stopLocationServicesMonitor(){this.locationMonitorInterval&&(clearInterval(this.locationMonitorInterval),this.locationMonitorInterval=null)}ngOnDestroy(){this.stopLocationServicesMonitor(),p.q.removeAllListeners()}}return(e=g).\u0275fac=function(t){return new(t||e)(h.KVO(E),h.KVO(j),h.KVO(k.OD))},e.\u0275prov=h.jDH({token:e,factory:e.\u0275fac,providedIn:"root"}),g})()}}]);